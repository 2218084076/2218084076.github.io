---
title: è§£å†³ GitLab CI ä½¿ç”¨ Kaniko æ„å»ºå¤šé•œåƒæ—¶ä¾èµ–ç¼“å­˜é—®é¢˜
aging: true
aging_days: 100
author: Terry
copyright_info: true
avatar: https://terry-photography-1308467839.cos.ap-nanjing.myqcloud.com/icon/logo.svg
date: 2024-10-12 12:47:42
tags: [ CI ]
home_cover: /images/posts/img.png
home_cover_height: 120
sticky: 999
category: CI
---

> åœ¨ä½¿ç”¨ gitlab ci åŒæ—¶æ„å»ºå¤šä¸ªé•œåƒçš„æ—¶å€™ï¼Œç”±äº Kaniko é»˜è®¤ä¼šä½¿ç”¨ç¼“å­˜ã€‚å¦‚æœ `A` ä¸­çš„ requirements.txt å·²ç»å®‰è£…è¿‡ï¼ŒKaniko
> å¯èƒ½è·³è¿‡ä¸€äº›å®‰è£…æ­¥éª¤ã€‚åœ¨ `B` é•œåƒæ„å»ºæ—¶ï¼Œç¼“å­˜å¯èƒ½å¯¼è‡´æŸäº›æ­¥éª¤æ²¡æœ‰è¢«é‡æ–°æˆ–å®Œå…¨æ‰§è¡Œã€‚
>
> è¿›è€Œä¼šå¯¼è‡´ requirements.txt æ–‡ä»¶åœ¨æ„å»ºåç»­é•œåƒæ—¶ä¸å¯è§æˆ–è¢«é”™è¯¯å¿½ç•¥ã€‚

## âŒå¼‚å¸¸å¤ç°

```yml
build:
  stage: build
  image:
    name: test-executor:v1.23.2-debug
    entrypoint: [ "" ]
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/webui/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/webui:${CI_COMMIT_TAG}"
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/api/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/api:${CI_COMMIT_TAG}"
  rules:
    - if: $CI_COMMIT_TAG
```

åœ¨ä½¿ç”¨ä»¥ä¸Š ci æ–‡ä»¶è¿›è¡Œæ„å»ºæ—¶ï¼Œæ‰§è¡Œåˆ°æ„å»º `api` å¯¹åº”é•œåƒæ—¶ï¼Œci æ—¥å¿—ä¸­ä¼šå‡ºç°
`No files changed in this command, skipping snapshotting.`æç¤º

æœ€åæ£€æŸ¥é•œåƒä¸­ pip ä¾èµ–æ—¶ä¼šå‘ç°ç¼ºå°‘å¾ˆå¤šå¿…è¦ä¾èµ–ï¼

```shell
$ /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/webui/Dockerfile" --destination "${CI_REGISTRY_IMAGE}/webui:${CI_COMMIT_TAG}"
INFO[0004] Running: [/bin/sh -c pip install --no-cache-dir -r requirements.txt]
...
Successfully installed MarkupSafe-3.0.1 Pillow-10.4.0 XlsxWriter-3.2.0 altair-5.4.1 
annotated-types-0.7.0 anyio-4.6.0 attrs-24.2.0 blinker-1.8.2 cachetools-5.5.0 certifi-2024.8.30 ...
 
$ /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/api/Dockerfile" --destination "${CI_REGISTRY_IMAGE}/api:${CI_COMMIT_TAG}"
INFO[0000] Using dockerignore file: /builds/poc/2409-rag-agent-app/.dockerignore 
...
âš ï¸ INFO[0004] No files changed in this command, skipping snapshotting. 
INFO[0004] Running: [/bin/sh -c pip install --no-cache-dir -r requirements.txt] 
...
Installing collected packages: uvicorn, starlette, fastapi
âš ï¸ Successfully installed fastapi-0.115.0 starlette-0.38.6 uvicorn-0.31.0
```

## ğŸ“—è§£å†³æ–¹æ³•

### å¤šæ¬¡è¿è¡Œ /kaniko/executor

åœ¨ `script` ä¸­ï¼Œä½ æ‰§è¡Œäº†ä¸¤æ¬¡ `/kaniko/executor` å‘½ä»¤ï¼Œ
åˆ†åˆ«ç”¨äºæ„å»º `webui` å’Œ `api` çš„ Docker é•œåƒã€‚

#### æ”¹è¿›å»ºè®®ï¼šå°† webui å’Œ api çš„æ„å»ºæ‹†åˆ†æˆå•ç‹¬çš„ä»»åŠ¡

```yml
build_webui:
  stage: build
  image:
    name: test-executor:v1.23.2-debug
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/webui/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/webui:${CI_COMMIT_TAG}"
  rules:
    - if: $CI_COMMIT_TAG

build_api:
  stage: build
  image:
    name: test-executor:v1.23.2-debug
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/api/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/api:${CI_COMMIT_TAG}"
  rules:
    - if: $CI_COMMIT_TAG
```

è¿™æ ·ï¼Œæ¯ä¸ªä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œå‡å°‘æ•´ä½“çš„æ„å»ºæ—¶é—´ã€‚

### ç¦ç”¨ Kaniko çš„ç¼“å­˜

ä½ è¿˜å¯ä»¥ç¦ç”¨ Kaniko çš„ç¼“å­˜æ¥ç¡®ä¿æ¯æ¬¡éƒ½é‡æ–°æ„å»º

```yml
- /kaniko/executor
  --context "${CI_PROJECT_DIR}"
  --dockerfile "${CI_PROJECT_DIR}/api/Dockerfile"
  --destination "${CI_REGISTRY_IMAGE}/api:${CI_COMMIT_TAG}"
  --no-cache
```

